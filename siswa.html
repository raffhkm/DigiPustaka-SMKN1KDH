<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siswa - DigiPustaka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --accent: #f59e0b;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-image: url('https://i.ibb.co.com/F4zQTGmv/file-00000000a2c87209b236e08d69571651.png');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            color: #1a1a1a;
            -webkit-tap-highlight-color: transparent;
        }

        /* Glassmorphism Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .login-bg {
            background-image: linear-gradient(rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.85)), 
                              url('https://i.ibb.co.com/JFsz4XHz/depositphotos-131494310-stock-photo-blurred-bookshelf-in-library.webp');
            background-size: cover;
            background-position: center;
        }

        /* UI Elements */
        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
            transition: all 0.3s ease;
        }

        .btn-primary:active { transform: scale(0.95); }

        .nav-active i { color: #2563eb; transform: translateY(-3px); }
        .nav-active span { color: #2563eb; font-weight: 800; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .search-input {
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .search-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .animate-slide-up { animation: slideUp 0.5s ease forwards; }

        .shimmer {
            position: absolute;
            inset: 0;
            background: linear-gradient(110deg, transparent 20%, rgba(255,255,255,0.2) 40%, transparent 60%);
            animation: shimmerMove 3s linear infinite;
        }

        @keyframes shimmerMove {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .book-card {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.book-card:hover {
    transform: translateY(-10px);
}
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;  
    overflow: hidden;
}

    </style>
</head>
<body class="pb-28">

    <div id="toast" class="fixed bottom-32 left-6 right-6 z-[6000] hidden transition-all duration-300">
        <div class="bg-slate-900 text-white px-6 py-4 rounded-2xl flex items-center gap-3 shadow-2xl">
            <i id="toastIcon" class="fas fa-check-circle text-emerald-400"></i>
            <span id="toastMsg" class="text-sm font-medium">Berhasil!</span>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 z-[7000] bg-white/70 backdrop-blur-md flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="w-14 h-14 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-black text-slate-800 tracking-tight">Menyiapkan Perpustakaan...</p>
        </div>
    </div>

    <div id="loginScreen" class="fixed inset-0 z-[5000] login-bg flex items-center justify-center p-6">
        <div class="w-full max-w-md animate-in fade-in zoom-in duration-500">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto shadow-2xl mb-4 overflow-hidden">
                    <img src="logo.jpg" alt="Logo" class="w-full h-full object-cover" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2232/2232688.png'">
                </div>
                <h1 class="text-4xl font-black text-white tracking-tight">Digi<span class="text-blue-400">Siswa</span></h1>
                <p class="text-slate-300 font-medium mt-2">Daftar Hadir & Akses Koleksi</p>
            </div>

            <div class="glass-card p-8 rounded-[40px] space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Identitas Siswa</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-4 flex items-center text-slate-400"><i class="fas fa-user"></i></span>
                        <input type="text" id="stu-name" placeholder="Nama Lengkap Anda" 
                            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:bg-white transition-all outline-none">
                    </div>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-4 flex items-center text-slate-400"><i class="fas fa-school"></i></span>
                        <input type="text" id="stu-class" placeholder="Kelas / Jurusan" 
                            class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:bg-white transition-all outline-none">
                    </div>
                </div>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase ml-1">Keperluan Kunjungan</label>
                    <select id="stu-purpose" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:bg-white">
                        <option value="Membaca">Hanya Membaca</option>
                        <option value="Meminjam">Meminjam Buku</option>
                        <option value="Kembalikan">Mengembalikan Buku</option>
                        <option value="Tugas">Mengerjakan Tugas</option>
                    </select>
                </div>

                <button onclick="handleLoginSiswa()" class="w-full btn-primary text-white py-5 rounded-2xl font-bold text-lg active:scale-95 transition-all">
                    Masuk Sekarang
                </button>
                <div class="pt-2">
    <a href="index.html" class="group w-full flex items-center justify-center gap-2 py-3 text-slate-400 hover:text-blue-600 font-semibold text-sm transition-all duration-300">
        <div class="w-8 h-8 rounded-full bg-slate-50 group-hover:bg-blue-50 flex items-center justify-center transition-colors">
            <i class="fas fa-arrow-left text-[10px] group-hover:-translate-x-0.5 transition-transform"></i>
        </div>
        <span>Kembali ke Beranda</span>
    </a>
</div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="bg-gradient-to-r from-blue-700 to-blue-900 text-white sticky top-0 z-[100] px-6 py-6 flex justify-between items-center rounded-b-[30px] shadow-lg">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-inner overflow-hidden">
                    <img src="logo.jpg" alt="Logo" class="w-full h-full object-cover" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2232/2232688.png'">
                </div>
                <div>
                    <h2 id="welcomeName" class="text-lg font-extrabold leading-none">Halo, Siswa</h2>
                    <p id="welcomeClass" class="text-[10px] text-blue-200 font-bold uppercase tracking-widest mt-1">MEMBACA ADALAH JENDELA DUNIA</p>
                </div>
            </div>
            <button onclick="logoutSiswa()" class="w-11 h-11 bg-white/10 rounded-2xl flex items-center justify-center hover:bg-red-500/30 transition-all">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </header>

        <main class="p-6">
                     <section id="sec-home" class="animate-in slide-in-from-bottom-4 duration-500 space-y-6">
                <div class="relative overflow-hidden bg-gradient-to-br from-indigo-600 to-blue-700 rounded-[35px] p-7 text-white shadow-2xl">
                    <div class="shimmer"></div>
                    <div class="bg-white/40 border border-white/60 p-4 rounded-3xl mb-6 flex items-center gap-4">
    <div class="text-2xl">ðŸ’¡</div>
    <p class="text-[11px] font-medium text-slate-600 leading-relaxed italic">
        "Jangan lupa kembalikan buku tepat waktu ya, agar teman-teman yang lain juga bisa berpetualang lewat buku ini!"
    </p>
</div>

                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-tighter opacity-80">Buku yang kamu pinjam</p>
                            <h3 id="stat-my-loans" class="text-5xl font-black mt-1">0</h3>
                        </div>
                        <div class="w-16 h-16 bg-white/20 rounded-3xl flex items-center justify-center backdrop-blur-md">
                            <i class="fas fa-book-reader text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-extrabold text-slate-800">Pinjaman Aktif</h4>
                        <span class="bg-blue-100 text-blue-600 text-[10px] px-3 py-1 rounded-full font-black">Maks. 3 Buku</span>
                    </div>
                    <div id="list-my-loans" class="space-y-4"></div>
                </div>

                <hr class="border-slate-200">

                <div>
                    <h4 class="font-extrabold text-slate-800 mb-4">Riwayat Kamu</h4>
                    <div id="list-my-history" class="space-y-3 opacity-80">
                        </div>
                </div>
            </section>


            <section id="sec-pinjam" class="hidden animate-in slide-in-from-right duration-300 space-y-6">
                <div class="glass-card p-7 rounded-[40px] border-t-4 border-t-blue-600 shadow-xl">
                    <h4 class="font-extrabold text-slate-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-plus-circle text-blue-600"></i> Form Pinjam Baru
                    </h4>
                    
                    <div class="space-y-5">
                        <div class="space-y-2 relative">
                            <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Pilih Buku</label>
                            <div class="relative">
                                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                                <input type="text" id="search-book" placeholder="Cari judul buku..." 
                                    class="w-full pl-12 pr-4 py-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none focus:bg-white" 
                                    onkeyup="filterBooks(this.value)">
                            </div>
                            <div id="book-results" class="absolute w-full bg-white border mt-2 rounded-2xl shadow-2xl max-h-60 overflow-y-auto z-[200] hidden p-2"></div>
                        </div>

                        <div id="selected-book-display" class="p-4 bg-emerald-50 border border-emerald-100 rounded-2xl hidden flex items-center gap-3">
                            <div class="w-12 h-12 bg-emerald-600 text-white rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-check"></i></div>
                            <div class="flex-1">
                                <p class="text-[10px] text-emerald-500 font-black uppercase">Buku Terpilih</p>
                                <p id="selected-book-title" class="text-sm font-extrabold text-emerald-900 leading-tight"></p>
                            </div>
                            <button onclick="resetBookSelection()" class="text-emerald-400"><i class="fas fa-times-circle text-xl"></i></button>
                        </div>
                        <input type="hidden" id="selected-book-id">

                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Jumlah</label>
                                <input type="number" id="loan-qty" value="1" min="1" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Batas Kembali</label>
                                <input type="date" id="loan-due" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none text-xs font-bold">
                            </div>
                        </div>

                        <button onclick="processStudentLoan()" class="w-full btn-primary text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-blue-200">
                            Proses Peminjaman
                        </button>
                    </div>
                </div>

                <div class="bg-amber-50 p-5 rounded-3xl border border-amber-100 flex items-start gap-4">
                    <i class="fas fa-info-circle text-amber-500 mt-1"></i>
                    <p class="text-[11px] text-amber-800 font-bold leading-relaxed">
                        PENTING: Harap kembalikan buku tepat waktu untuk menghindari denda Rp 2.000/hari dan agar teman lain bisa meminjam.
                    </p>
                </div>
            </section>

            <section id="sec-katalog" class="hidden animate-in slide-in-from-right duration-300 space-y-6">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    <input type="text" placeholder="Cari buku di semua kategori..." 
                        class="w-full pl-12 pr-4 py-4 bg-white border border-slate-100 rounded-2xl text-sm shadow-sm" 
                        onkeyup="searchKatalog(this.value)">
                </div>

                <div id="katalogTabs" class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                    <button onclick="setCat('Pelajaran')" class="tab-btn-siswa active px-6 py-3 rounded-2xl font-extrabold text-xs whitespace-nowrap bg-blue-600 text-white shadow-lg shadow-blue-100 transition-all">Pelajaran</button>
                    <button onclick="setCat('Fiksi')" class="tab-btn-siswa px-6 py-3 rounded-2xl font-extrabold text-xs whitespace-nowrap bg-white text-slate-500 transition-all">Fiksi</button>
                    <button onclick="setCat('Pengetahuan')" class="tab-btn-siswa px-6 py-3 rounded-2xl font-extrabold text-xs whitespace-nowrap bg-white text-slate-500 transition-all">Pengetahuan</button>
                </div>

                <div id="list-katalog" class="grid grid-cols-1 gap-6 pb-20">
                    </div>
            </section>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 h-24 bg-white/90 backdrop-blur-xl border-t border-slate-100 flex justify-around items-center px-4 z-[1000] rounded-t-[35px] shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
            <button onclick="nav('home')" class="nav-btn flex flex-col items-center gap-1 nav-active flex-1">
                <i class="fas fa-house-user text-xl"></i>
                <span class="text-[9px] uppercase tracking-tighter">Beranda</span>
            </button>
            <button onclick="nav('pinjam')" class="nav-btn flex flex-col items-center gap-1 text-slate-400 flex-1">
                <div class="w-14 h-14 bg-blue-600 -mt-12 rounded-2xl flex items-center justify-center text-white shadow-2xl shadow-blue-300 border-4 border-white animate-bounce-subtle">
                    <i class="fas fa-plus text-xl"></i>
                </div>
                <span class="text-[9px] uppercase tracking-tighter mt-1">Pinjam</span>
            </button>
            <button onclick="nav('katalog')" class="nav-btn flex flex-col items-center gap-1 text-slate-400 flex-1">
                <i class="fas fa-book-open text-xl"></i>
                <span class="text-[9px] uppercase tracking-tighter">Katalog</span>
            </button>
        </nav>
    </div>

    <div id="customModal" class="fixed inset-0 z-[8000] hidden flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="relative bg-white w-full max-w-xs rounded-[40px] p-8 shadow-2xl animate-in zoom-in duration-300 text-center">
            <div id="modalIcon" class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 bg-blue-100 text-blue-600">
                <i class="fas fa-info-circle text-2xl"></i>
            </div>
            <h3 id="modalTitle" class="font-black text-slate-800 text-xl leading-tight mb-2">Konfirmasi</h3>
            <p id="modalDesc" class="text-slate-500 text-xs font-medium mb-8"></p>
            <div class="flex flex-col gap-3">
                <button id="modalConfirmBtn" class="w-full py-4 rounded-2xl bg-blue-600 text-white font-black text-sm active:scale-95 transition-all">Lanjutkan</button>
                <button onclick="closeModal()" class="w-full py-4 rounded-2xl bg-slate-100 text-slate-500 font-bold text-sm active:scale-95 transition-all">Batal</button>
            </div>
        </div>
    </div>

  <script>
    // --- KONFIGURASI API ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz3FmPrVVVGbFWHK7Yp8iMQh-BS5U9iuA2fsTXWQLE9kijWtDx_ns3ti5_ickFUGZA7/exec"; 

    let state = {
        books: [],
        members: [],
        loans: [],
        history: [],
        visitors: []
    };

    let currentStudent = {
        nama: "",
        kelas: ""
    };

    let currentCategory = 'Pelajaran';

    // --- AUDIO ENGINE ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let successBuffer = null;

    fetch('https://image2url.com/r2/default/audio/1770772810191-40079260-dc5c-4598-b982-4b62fe9cba92.mp3')
        .then(res => res.arrayBuffer())
        .then(data => audioCtx.decodeAudioData(data))
        .then(buffer => successBuffer = buffer);

    function playDing() {
        if (!successBuffer) return;
        const source = audioCtx.createBufferSource();
        source.buffer = successBuffer;
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 0.3;
        source.connect(gainNode).connect(audioCtx.destination);
        source.start(0);
    }

    // --- AUTH & LOGIN ---
  async function handleLoginSiswa() {
    const name = document.getElementById('stu-name').value.trim();
    const cls = document.getElementById('stu-class').value.trim();
    const purpose = document.getElementById('stu-purpose').value;

    if (!name || !cls) return showToast("Mohon isi Nama & Kelas!", true);

    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.querySelector('#loadingOverlay p').innerText = "Sinkronisasi Data...";

    try {
        // 1. AMBIL DATA TERBARU (Sangat Penting: Ambil SEMUA sheet)
        const response = await fetch(APPS_SCRIPT_URL);
        const cloudData = await response.json();
        
        // 2. Update state lokal (PASTIKAN 'anggota/members' ikut diambil agar tidak hilang)
        state.books = cloudData.buku || [];
        state.members = cloudData.anggota || []; // <--- BARIS INI YANG TADI HILANG
        state.loans = cloudData.pinjaman || [];
        state.history = cloudData.riwayat || [];
        state.visitors = cloudData.tamu || [];

        // 3. Tambahkan kunjungan baru ke array visitors
        currentStudent = { nama: name, kelas: cls };
        const newVisitor = {
            id: Date.now(),
            nama: name,
            kelas: cls,
            tujuan: purpose,
            waktu: new Date().toLocaleString('id-ID')
        };
        state.visitors.push(newVisitor);

        // 4. Kirim balik ke cloud (Sekarang state.members sudah ada isinya, jadi aman)
        await saveToCloud();
        
        // Setup UI
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('welcomeName').innerText = `Halo, ${name.split(' ')[0]}!`;
        document.getElementById('welcomeClass').innerText = cls;

        refreshSiswaUI();
        showToast("Kehadiran berhasil dicatat!");
    } catch(e) {
        console.error(e);
        showToast("Gagal terhubung ke server", true);
    } finally {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }
}

// --- FUNGSI PENGEMBALIAN BUKU ---
async function studentReturnBook(id) {
    // Cari data pinjaman berdasarkan ID
    const loanIndex = state.loans.findIndex(l => l.id === id);
    if (loanIndex === -1) return;

    const loan = state.loans[loanIndex];

    openModal({
        title: "Kembalikan Buku?",
        desc: `Apakah kamu ingin mengembalikan "${loan.judulBuku}" sekarang?`,
        onConfirm: async () => {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.querySelector('#loadingOverlay p').innerText = "Memproses Pengembalian...";

            try {
                // 1. Tambahkan ke Riwayat
                const historyEntry = {
                    id: Date.now(),
                    nama: loan.namaAnggota,
                    buku: loan.judulBuku,
                    tglPinjam: loan.tglPinjam,
                    tglKembali: new Date().toISOString(),
                    status: "Selesai"
                };
                state.history.unshift(historyEntry);

                // 2. Kembalikan Stok Buku
                const book = state.books.find(b => b.judul === loan.judulBuku);
                if (book) {
                    book.stok = parseInt(book.stok) + parseInt(loan.jumlah);
                }

                // 3. Hapus dari daftar Pinjaman Aktif
                state.loans.splice(loanIndex, 1);

                // 4. Simpan ke Cloud
                await saveToCloud();
                
                // Beri jeda sedikit agar Google Sheets selesai menulis
                setTimeout(async () => {
                    await loadDataFromCloud();
                    playDing();
                    showToast("Buku berhasil dikembalikan!");
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1000);

            } catch (error) {
                console.error(error);
                showToast("Terjadi kesalahan saat mengembalikan", true);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }
    });
}

    function logoutSiswa() {
    openModal({
        title: "Akhiri Kunjungan?",
        desc: "Terima kasih sudah berkunjung ke DigiPustaka hari ini. Sampai jumpa di petualangan literasi berikutnya!",
        onConfirm: () => { 
            // Tambahkan efek loading sebentar biar keren
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.querySelector('#loadingOverlay p').innerText = "Menutup Sesi...";
            
            setTimeout(() => {
                window.location.href = "index.html"; 
            }, 1000);
        }
    });
}

    // --- DATA ENGINE ---
    async function loadDataFromCloud() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
        try {
            const response = await fetch(APPS_SCRIPT_URL);
            const data = await response.json();
            state = {
                books: data.buku || [],
                members: data.anggota || [],
                loans: data.pinjaman || [],
                history: data.riwayat || [],
                visitors: data.tamu || []
            };
            refreshSiswaUI();
        } catch(e) { 
            showToast("Gagal memuat data.", true); 
        } finally { 
            document.getElementById('loadingOverlay').classList.add('hidden'); 
        }
    }

   async function saveToCloud() {
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Apps Script butuh ini agar tidak kena CORS error
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(state)
        });
        // Karena no-cors, kita tidak bisa baca respon, 
        // tapi jika sampai ke baris ini tanpa throw error berat, kita anggap aman.
        console.log("Data dikirim ke server...");
        return true; 
    } catch(e) { 
        console.error("Sync Error", e);
        throw e;
    }
}

    // --- RENDERERS ---
   function renderMyLoans(list) {
    const container = document.getElementById('list-my-loans');
    container.innerHTML = list.map(l => {
        const due = new Date(l.tglKembali);
        const pinjam = new Date(l.tglPinjam);
        const today = new Date();
        today.setHours(0,0,0,0);
        
        // Hitung selisih hari
        const diff = Math.ceil((due - today) / 86400000);
        
        // Logika Teks dan Warna
        let statusText = "";
        let colorClass = "";
        
        if (diff < 0) {
            // Jika telat (angka negatif)
            statusText = `TELAT ${Math.abs(diff)} HARI`; // Math.abs membuang tanda minus (-)
            colorClass = "border-red-500 bg-red-100 text-red-600";
        } else if (diff === 0) {
            // Jika hari ini batasnya
            statusText = "TERAKHIR HARI INI";
            colorClass = "border-amber-500 bg-amber-100 text-amber-600";
        } else {
            // Jika masih ada sisa waktu
            statusText = `SISA ${diff} HARI`;
            colorClass = "border-blue-500 bg-emerald-100 text-emerald-600";
        }

        const borderClass = diff < 0 ? 'border-red-500' : (diff <= 1 ? 'border-amber-500' : 'border-blue-500');
        
        const formatWaktu = pinjam.toLocaleDateString('id-ID', { 
            day: 'numeric', month: 'long', year: 'numeric' 
        }) + ' ' + pinjam.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

        return `
        <div class="glass-card p-6 rounded-[35px] border-l-[10px] ${borderClass} animate-slide-up shadow-md relative overflow-hidden">
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <h5 class="font-extrabold text-lg text-slate-800 leading-tight">${l.judulBuku}</h5>
                    <div class="flex items-center gap-2 mt-1 text-blue-600">
                         <i class="fas fa-book text-[10px]"></i>
                         <span class="text-[11px] font-black uppercase tracking-wider">Koleksi Digital</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="openEditModal(${l.id})" class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center shadow-sm">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button onclick="studentReturnBook(${l.id})" class="px-5 bg-blue-600 text-white rounded-2xl text-[10px] font-black uppercase shadow-lg">Kembalikan</button>
                </div>
            </div>

            <div class="flex gap-2 mb-4">
                <span class="bg-blue-100 text-blue-700 text-[10px] px-3 py-1 rounded-lg font-black">${l.jumlah} BUKU</span>
                <span class="${colorClass} text-[10px] px-3 py-1 rounded-lg font-black flex items-center gap-1">
                    <i class="far fa-clock"></i> ${statusText}
                </span>
            </div>

            <div class="flex justify-between items-center pt-3 border-t border-slate-100">
                <div>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">Pinjam: ${formatWaktu}</p>
                </div>
                <div>
                    <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter text-right">Batas: ${due.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p>
                </div>
            </div>
        </div>`;
    }).join('') || `<div class="text-center py-8 opacity-40 text-xs italic font-medium">Tidak ada pinjaman aktif</div>`;
}

// Membuka Modal Edit
function openEditModal(id) {
    const loan = state.loans.find(l => l.id === id);
    if(!loan) return;

    document.getElementById('edit-loan-id').value = id;
    document.getElementById('edit-loan-book-title').innerText = loan.judulBuku;
    document.getElementById('edit-loan-qty').value = loan.jumlah;
    document.getElementById('edit-loan-due').value = loan.tglKembali.split('T')[0];
    
    document.getElementById('editLoanModal').classList.remove('hidden');
}

function closeEditModal() {
    document.getElementById('editLoanModal').classList.add('hidden');
}

// Tambah/Kurang jumlah di modal
function adjustEditQty(val) {
    const input = document.getElementById('edit-loan-qty');
    let current = parseInt(input.value) + val;
    if(current < 1) current = 1;
    input.value = current;
}

// Simpan Perubahan
// Simpan Perubahan Edit Pinjaman
async function confirmEditLoan() {
    const id = parseInt(document.getElementById('edit-loan-id').value);
    const newQty = parseInt(document.getElementById('edit-loan-qty').value);
    const newDue = document.getElementById('edit-loan-due').value;

    const loanIndex = state.loans.findIndex(l => l.id === id);
    if(loanIndex > -1) {
        // Tampilkan loading sebentar saja (feedback visual)
        document.getElementById('loadingOverlay').classList.remove('hidden');
        document.querySelector('#loadingOverlay p').innerText = "Menyimpan perubahan...";

        // Update data lokal
        state.loans[loanIndex].jumlah = newQty;
        state.loans[loanIndex].tglKembali = newDue;
        
        try {
            // Kirim ke cloud tanpa menunggu (background sync)
            saveToCloud();
            
            // Tutup modal & Refresh UI segera agar terasa instan
            setTimeout(() => {
                closeEditModal();
                refreshSiswaUI();
                document.getElementById('loadingOverlay').classList.add('hidden');
                
                // Beri suara dan toast sukses
                playDing();
                showToast("Perubahan berhasil disimpan!");
            }, 600); // 0.6 detik saja biar tidak dikira ngebug
            
        } catch(e) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            showToast("Gagal sinkronisasi data", true);
        }
    }
}



    function renderMyHistory(list) {
    const container = document.getElementById('list-my-history');
    container.innerHTML = list.map(h => {
        const tglPinjam = new Date(h.tglPinjam).toLocaleDateString('id-ID', { 
            day: 'numeric', month: 'short', year: 'numeric' 
        });
        const tglKembali = new Date(h.tglKembali).toLocaleDateString('id-ID', { 
            day: 'numeric', month: 'short', year: 'numeric' 
        });
        const jamKembali = new Date(h.tglKembali).toLocaleTimeString('id-ID', { 
            hour: '2-digit', minute: '2-digit' 
        });

        return `
        <div class="glass-card p-5 rounded-[30px] border-l-[10px] border-emerald-500 animate-slide-up shadow-sm mb-4">
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <h5 class="font-extrabold text-sm text-slate-800 leading-tight">${h.buku}</h5>
                    <p class="text-[10px] text-slate-400 font-bold mt-1 uppercase tracking-wider">
                        <i class="fas fa-calendar-alt mr-1"></i> Pinjam: ${tglPinjam}
                    </p>
                </div>
                <div class="bg-emerald-100 text-emerald-600 px-3 py-1.5 rounded-xl flex items-center gap-1.5">
                    <i class="fas fa-check-circle text-[10px]"></i>
                    <span class="text-[9px] font-black uppercase">Selesai</span>
                </div>
            </div>

            <div class="flex justify-between items-center pt-3 border-t border-dashed border-slate-200">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center text-slate-500">
                        <i class="fas fa-undo-alt text-xs"></i>
                    </div>
                    <div>
                        <p class="text-[8px] text-slate-400 font-black uppercase leading-none">Dikembalikan Pada</p>
                        <p class="text-[11px] text-slate-700 font-extrabold mt-0.5">${tglKembali} â€¢ ${jamKembali}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[8px] text-emerald-500 font-black uppercase bg-emerald-50 px-2 py-1 rounded-md">Status Aman</p>
                </div>
            </div>
        </div>`;
    }).join('') || `
        <div class="flex flex-col items-center justify-center py-12 opacity-30">
            <i class="fas fa-history text-4xl mb-3"></i>
            <p class="text-xs font-bold italic">Belum ada riwayat aktivitas</p>
        </div>`;
}


    function renderKatalog(list) {
    const container = document.getElementById('list-katalog');
    const filtered = list.filter(b => b.kategori === currentCategory);
    
    container.innerHTML = filtered.map(b => {
        const isOutOfStock = b.stok <= 0;
        const stockColor = isOutOfStock ? 'text-red-500' : 'text-emerald-500';
        const btnClass = isOutOfStock 
            ? 'bg-slate-200 text-slate-400 cursor-not-allowed' 
            : 'bg-blue-600 text-white shadow-blue-200 active:scale-90 hover:bg-blue-700';

        return `
        <div class="book-card glass-card overflow-hidden rounded-[35px] flex shadow-lg border-none animate-slide-up">
            <div class="w-32 h-44 bg-slate-100 flex-shrink-0 relative">
                <img src="${b.fotoUrl || 'https://images.unsplash.com/photo-1543002588-bfa74002ed7e?q=80&w=1000&auto=format&fit=crop'}" 
                     class="w-full h-full object-cover" 
                     onerror="this.src='https://via.placeholder.com/150x200?text=No+Cover'">
                ${isOutOfStock ? '<div class="absolute inset-0 bg-black/40 backdrop-blur-[2px] flex items-center justify-center"><span class="bg-white/90 px-3 py-1 rounded-full text-[10px] font-black text-red-600">HABIS</span></div>' : ''}
            </div>

            <div class="p-5 flex-1 flex flex-col justify-between bg-white/50">
                <div>
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[9px] font-black text-blue-500 uppercase tracking-widest">${b.kategori}</span>
                        <div class="flex items-center gap-1">
                            <i class="fas fa-box ${stockColor} text-[10px]"></i>
                            <span class="text-[10px] font-bold ${stockColor}">Stok: ${b.stok}</span>
                        </div>
                    </div>
                    <h4 class="font-black text-slate-800 text-sm leading-tight line-clamp-2 mb-1 uppercase tracking-tight">${b.judul}</h4>
                    <p class="text-[10px] text-slate-400 font-medium italic mb-2">Oleh: ${b.penulis || 'Anonim'}</p>
                </div>

                <button onclick="${isOutOfStock ? '' : `quickPickBook(${b.id})`}" 
                    class="w-full py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2 ${btnClass}">
                    ${isOutOfStock ? '<i class="fas fa-times-circle"></i> Stok Habis' : '<i class="fas fa-bookmark"></i> Pinjam Buku'}
                </button>
            </div>
        </div>`;
    }).join('') || `<div class="text-center py-20 opacity-40"><i class="fas fa-book-open text-4xl mb-3"></i><p class="font-bold">Koleksi belum tersedia</p></div>`;
}

    // --- LOGIC FUNCTIONS ---
    async function processStudentLoan() {
    const bId = document.getElementById('selected-book-id').value;
    const qty = parseInt(document.getElementById('loan-qty').value);
    const due = document.getElementById('loan-due').value;

    if(!bId || !due) return showToast("Data belum lengkap!", true);
    
    const book = state.books.find(b => b.id == bId);
    if(!book || book.stok < qty) return showToast("Stok tidak mencukupi!", true);

    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.querySelector('#loadingOverlay p').innerText = "Memproses Pinjaman...";

    // Tambah ke local state
    const newLoan = {
        id: Date.now(),
        namaAnggota: currentStudent.nama,
        kelas: currentStudent.kelas,
        judulBuku: book.judul,
        jumlah: qty,
        tglPinjam: new Date().toISOString(),
        tglKembali: due,
        status: 'Dipinjam'
    };
    state.loans.push(newLoan);
    book.stok -= qty;

    // Kirim ke Cloud
    await saveToCloud(); 
    
    // Kita langsung panggil loadData untuk sinkronisasi ulang
    // Tanpa menunggu konfirmasi 'Success' yang terhalang CORS
    setTimeout(async () => {
        try {
            await loadDataFromCloud();
            playDing();
            showToast("Berhasil meminjam!");
            resetBookSelection();
            nav('home');
        } catch(err) {
            console.log("Refresh data tertunda...");
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    }, 1500); // Beri jeda 1.5 detik agar Google Script selesai menulis di Sheet
}

    // --- HELPERS (Tetap sama seperti kode Anda) ---
    function filterBooks(q) {
        const res = document.getElementById('book-results');
        if(!q) return res.classList.add('hidden');
        const filtered = state.books.filter(b => b.judul.toLowerCase().includes(q.toLowerCase()));
        res.innerHTML = filtered.map(b => `
            <div onclick="selectBookForLoan(${b.id}, '${b.judul}')" class="p-4 border-b hover:bg-blue-50 text-sm font-bold flex justify-between cursor-pointer">
                <span>${b.judul}</span>
                <span class="text-[10px] bg-slate-100 px-2 py-1 rounded">Stok: ${b.stok}</span>
            </div>`).join('');
        res.classList.remove('hidden');
    }

    function selectBookForLoan(id, judul) {
        document.getElementById('selected-book-id').value = id;
        document.getElementById('selected-book-title').innerText = judul;
        document.getElementById('selected-book-display').classList.remove('hidden');
        document.getElementById('book-results').classList.add('hidden');
    }

    function resetBookSelection() {
        document.getElementById('selected-book-id').value = "";
        document.getElementById('selected-book-display').classList.add('hidden');
    }

    function quickPickBook(id) {
        const b = state.books.find(x => x.id === id);
        selectBookForLoan(id, b.judul);
        nav('pinjam');
    }

    function showToast(msg, isError = false) {
        const toast = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        document.getElementById('toastIcon').className = isError ? "fas fa-exclamation-circle text-red-500" : "fas fa-check-circle text-emerald-400";
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function openModal({ title, desc, onConfirm }) {
        const modal = document.getElementById('customModal');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalDesc').innerText = desc;
        document.getElementById('modalConfirmBtn').onclick = () => { onConfirm(); closeModal(); };
        modal.classList.remove('hidden');
    }

    function closeModal() { document.getElementById('customModal').classList.add('hidden'); }

    window.onload = () => {
        setTimeout(() => { document.getElementById('loadingOverlay').classList.add('hidden'); }, 1000);
    };
    // --- FUNGSI NAVIGASI ---
function nav(target) {
    // Sembunyikan semua section
    document.getElementById('sec-home').classList.add('hidden');
    document.getElementById('sec-pinjam').classList.add('hidden');
    document.getElementById('sec-katalog').classList.add('hidden');

    // Tampilkan yang dipilih
    document.getElementById('sec-' + target).classList.remove('hidden');

    // Update style tombol navbar
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('nav-active');
        btn.classList.add('text-slate-400');
    });

    // Aktifkan tombol yang diklik
    event.currentTarget.classList.add('nav-active');
    event.currentTarget.classList.remove('text-slate-400');
}

// --- FUNGSI KATALOG & FILTER ---
function setCat(cat) {
    currentCategory = cat;
    document.querySelectorAll('.tab-btn-siswa').forEach(btn => {
        btn.classList.remove('bg-blue-600', 'text-white', 'active');
        btn.classList.add('bg-white', 'text-slate-500');
    });
    event.currentTarget.classList.add('bg-blue-600', 'text-white', 'active');
    renderKatalog(state.books);
}

function searchKatalog(q) {
    const filtered = state.books.filter(b => 
        b.judul.toLowerCase().includes(q.toLowerCase())
    );
    const container = document.getElementById('list-katalog');
    // Logika render mirip renderKatalog tapi pakai list hasil filter
    container.innerHTML = filtered.map(b => {
        // ... (gunakan template literal yang sama dengan fungsi renderKatalog kamu)
    }).join('');
}

// --- REFRESH UI ---
function refreshSiswaUI() {
    if (!currentStudent.nama) return;

    // Filter pinjaman milik siswa yang sedang login (tambah toleransi case sensitive)
    const myLoans = state.loans.filter(l => 
        l.namaAnggota.toLowerCase().trim() === currentStudent.nama.toLowerCase().trim()
    );
    
    const myHistory = state.history.filter(h => 
        h.nama.toLowerCase().trim() === currentStudent.nama.toLowerCase().trim()
    );
    
    document.getElementById('stat-my-loans').innerText = myLoans.length;
    renderMyLoans(myLoans);
    renderMyHistory(myHistory);
    renderKatalog(state.books);
}

</script>

        <div id="editLoanModal" class="fixed inset-0 z-[9000] hidden flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
        <div class="relative glass-card w-full max-w-sm rounded-[40px] p-8 shadow-2xl animate-in zoom-in duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-slate-800 text-xl">Ubah Pinjaman</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>
            
            <input type="hidden" id="edit-loan-id">
            
            <div class="space-y-4">
                <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                    <p class="text-[10px] text-blue-500 font-black uppercase">Buku</p>
                    <p id="edit-loan-book-title" class="text-sm font-extrabold text-blue-900 leading-tight"></p>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Jumlah Buku</label>
                    <div class="flex items-center gap-4">
                        <button onclick="adjustEditQty(-1)" class="w-12 h-12 bg-white border border-slate-100 rounded-xl flex items-center justify-center text-blue-600 shadow-sm active:scale-90"><i class="fas fa-minus"></i></button>
                        <input type="number" id="edit-loan-qty" class="flex-1 py-3 bg-slate-50 border-none rounded-xl text-center font-black text-lg outline-none" readonly>
                        <button onclick="adjustEditQty(1)" class="w-12 h-12 bg-white border border-slate-100 rounded-xl flex items-center justify-center text-blue-600 shadow-sm active:scale-90"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Batas Kembali Baru</label>
                    <input type="date" id="edit-loan-due" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl outline-none font-bold text-sm">
                </div>

                <button onclick="confirmEditLoan()" class="w-full btn-primary text-white py-5 rounded-2xl font-black text-lg shadow-xl shadow-blue-200 mt-4">
                    Simpan Perubahan
                </button>
            </div>
        </div>
    </div>
    
</body>
</html>
